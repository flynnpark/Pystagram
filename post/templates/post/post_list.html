{% extends "post/layout.html" %}
{% load humanize %}
{% load post_extras %} {# custom filter 추가 #}

{% if tag %}
    {% block title %}
        #{{ tag }} - Pystagram
    {% endblock %}
{% endif %}

{% block content %}
    {% if tag %}
        {% if not post_list %}
            <p>"#{{ tag }}" 태그 검색 결과가 없습니다.</p>
        {% else %}
            <p>"#{{ tag }}" 태그 검색 결과</p>
            <p>게시물 {{ post_list.count|intcomma }}개</p>
        {% endif %}
    {% endif %}
    {% for post in post_list %}
        <ul>
            <li>{{ post.author.profile.nickname }}</li>
            {% if post.author == user %}
            <li><a href="{% url "post:post_edit" post.pk %}">수정</a> / <a href="{% url "post:post_delete" post.pk %}" onClick="return confirm('정말 삭제하시겠습니까?')">삭제</a></li>
            {% endif %}
            <li>
                <input type="button" class="like" name="{{ post.id }}" value="Like">
                <p id="count-{{ post.id }}">{{ post.like_count }}개</p>
                <p id="like-user-{{ post.id }}">
                    {% for like_user in post.like_user_set.all %}
                        {{ like_user.profile.nickname }}
                    {% endfor %}
                </p>
            </li>
            <li><img src="{{ post.photo.url }}" alt="{{ post.author }}의 사진"></li>
            {{ post|add_link|safe|linebreaksbr }}
            <li>{{ post.created_at|naturaltime }}</li>
        </ul>
    {% endfor %}

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type="text/javascript">
        $(".like").click(function() {
            var pk = $(this).attr('name');
            $.ajax({ // .like 버튼을 클릭하면 새로고침 없이 ajax로 서버와 통신한다.
                type: "POST",
                url: "{% url 'post:post_like' %}",
                data: { 'pk': pk, 'csrfmiddlewaretoken': '{{ csrf_token }}'},
                dataType: "json",
                success: function(response) {
                    alert(response.message);
                    $("#count-" + pk).html(response.like_count + "개");

                    var users = $("#like-user-" + pk).text();

                    if (users.indexOf(response.nickname) != -1) {
                        $("#like-user-" + pk).text(users.replace(response.nickname, ""));
                    } else {
                        $("#like-user-" + pk).,text(response.nickname + users);
                    }
                },
                error: function(request, status, error) {
                    alert("로그인이 필요합니다.");
                    window.location.replace("/accounts/login/");
                }
            })
        })

    </script>
{% endblock %}
